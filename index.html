<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>
      Goban
    </title>

    <link rel="stylesheet" href="/goban.css" />

    <!-- Enable the homescreen app on mobile devices -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

    <!-- Enable the App Icon -->
    <link rel="icon" type="image/png" sizes="196x196" href="/assets/icon.png" />
    <link rel="apple-touch-icon" href="/assets/icon.png" />
    <link rel="apple-touch-startup-image" href="/assets/icon.png" />
    <link rel="manifest" href="/assets/site.webmanifest" />
    <meta name="viewport" content="width=device-width" />
    <meta
      name="viewport"
      content="initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, height=device-height, width=device-width"
    />
  </head>

  <body>
    <div id="goban"></div>
    <script type="text/javascript" src="/{{JS_FILE}}"></script>
  </body>

  <script type="text/javascript">
    var key = "goban";
    var storedData = localStorage.getItem(key);
    var flags = storedData ? JSON.parse(storedData) : null;

    var app = Elm.Main.init({
      flags,
      node: document.getElementById("goban"),
    });
   

    function createGameConnection(gameId) {
              // Creates the new WebSocket connection.
        socket = new WebSocket("{{CABLE_URL}}");

      socket.onopen = function(event) {
       app.ports.setStorage.subscribe(function (state) {
          if (state === null) {
            localStorage.removeItem(key);
          } else {
            console.log("stat", state);
            localStorage.setItem(key, JSON.stringify(state));
            localStorage.setItem("bb-" +Date.now(), JSON.stringify(state)); // just to be sure
            const msg = {
              command: 'message',
              data: JSON.stringify({action: 'state', state: state}),
              identifier: JSON.stringify({channel: "GameChannel", id: "ab0dc465-fd83-4ad9-86d1-04da44a90f4c"})

            }
            socket.send(JSON.stringify(msg))
            console.log('sended a message: ', msg)
          }
        });


 
         // When the connection is first created, this code runs subscribing the client to a specific chatroom stream in the ChatRoomChannel.
        
            console.log('WebSocket is connected.');
            const msg = {
                command: 'subscribe',
                identifier: JSON.stringify({channel: "GameChannel", id: "ab0dc465-fd83-4ad9-86d1-04da44a90f4c"}), 
            };
            socket.send(JSON.stringify(msg));
        };
        
        // When the connection is closed, this code will run.
        socket.onclose = function(event) {
             console.log('WebSocket is closed.');
        };
        // When a message is received through the websocket, this code will run.
        socket.onmessage = function(event) {            
            const response = event.data;
            const msg = JSON.parse(response);
            
            // Ignores pings.
            if (msg.type === "ping") {
                return;
            }
            console.log("FROM RAILS: ", msg);
            
            // Renders any newly created messages onto the page.
            if (msg.message) {
                console.log(msg.message)
                if (msg.message.action === "state") {
                  console.log('send state to elm', msg.message.state)
                  app.ports.fromCable.send(JSON.stringify(msg.message.state))
                }
                            

            }
            
        };
        
        // When an error occurs through the websocket connection, this code is run printing the error message.
        socket.onerror = function(error) {
            console.log('WebSocket Error: ' + JSON.stringify(error));
        };
    }
    createGameConnection('abc')
  </script>
</html>
